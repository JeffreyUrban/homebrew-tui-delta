name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for PyPI release
        id: wait
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          echo "Waiting for PyPI release of version ${VERSION}..."

          # Wait up to 10 minutes for the release to appear on PyPI
          MAX_ATTEMPTS=60
          SLEEP_TIME=10

          for i in $(seq 1 "$MAX_ATTEMPTS"); do
            echo "Attempt ${i}/${MAX_ATTEMPTS}: Checking PyPI..."

            # Fetch PyPI data and validate response before parsing
            RESPONSE=$(curl -s https://pypi.org/pypi/tui_delta/json)

            # Check if we got a valid JSON response
            if [ -n "$RESPONSE" ] && echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
              # Valid JSON - extract releases
              RELEASES=$(echo "$RESPONSE" | jq -r '.releases | keys[]' 2>/dev/null || echo "")

              if echo "$RELEASES" | grep -q "^${VERSION}$"; then
                echo "✅ Version ${VERSION} found on PyPI!"
                echo "release_found=true" >> "$GITHUB_OUTPUT"
                break
              fi
            else
              echo "⚠️  Invalid or empty response from PyPI, will retry..."
            fi

            if [ "$i" -eq "$MAX_ATTEMPTS" ]; then
              echo "❌ Timeout: Version ${VERSION} not found on PyPI after ${MAX_ATTEMPTS} attempts"
              echo "release_found=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi

            echo "Version not yet available, waiting ${SLEEP_TIME}s..."
            sleep "$SLEEP_TIME"
          done

      - name: Get package info from PyPI
        id: pypi
        if: steps.wait.outputs.release_found == 'true'
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          echo "Fetching package info for version ${VERSION}"

          # Wait a bit longer for package metadata to be fully available
          echo "Waiting additional 30 seconds for package metadata to propagate..."
          sleep 30

          # Retry fetching package info with exponential backoff
          MAX_ATTEMPTS=5
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Fetching package info..."

            # Get source distribution info
            INFO=$(curl -s https://pypi.org/pypi/tui_delta/json | jq -r ".releases[\"${VERSION}\"][] | select(.packagetype==\"sdist\")")
            URL=$(echo "$INFO" | jq -r '.url')
            SHA256=$(echo "$INFO" | jq -r '.digests.sha256')

            if [ -n "$URL" ] && [ -n "$SHA256" ] && [ "$URL" != "null" ] && [ "$SHA256" != "null" ]; then
              echo "url=${URL}" >> "$GITHUB_OUTPUT"
              echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
              echo "✅ Package URL: ${URL}"
              echo "✅ SHA256: ${SHA256}"
              exit 0
            fi

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "❌ Error: Could not fetch package info from PyPI after ${MAX_ATTEMPTS} attempts"
              echo "URL: ${URL}"
              echo "SHA256: ${SHA256}"
              exit 1
            fi

            WAIT_TIME=$((ATTEMPT * 10))
            echo "Package info not ready, waiting ${WAIT_TIME}s before retry..."
            sleep $WAIT_TIME
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Update formula
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          URL="${{ steps.pypi.outputs.url }}"
          SHA256="${{ steps.pypi.outputs.sha256 }}"

          # Update main package URL and SHA256
          # Note: PyPI normalizes package names by converting hyphens to underscores in filenames
          # Match both forms: tui_delta and tui_delta
          sed -i "s|url \"https://files.pythonhosted.org/packages/.*/tui_delta-.*\.tar\.gz\"|url \"${URL}\"|" Formula/tui-delta.rb

          # Find the sha256 line that follows the package url and update it
          # Note: Match both hyphen and underscore variants due to PyPI normalization
          awk -v url="${URL}" -v sha="${SHA256}" '
            /url "https:.*tui_delta-/ { print; getline; sub(/sha256 ".*"/, "sha256 \"" sha "\""); print; next }
            {print}
          ' Formula/tui-delta.rb > Formula/tui-delta.rb.tmp
          mv Formula/tui-delta.rb.tmp Formula/tui-delta.rb

          # Update version in test
          sed -i "s/assert_match \"tui-delta version .*/assert_match \"tui-delta version $VERSION\", output/" Formula/tui-delta.rb

          echo "✅ Formula updated"

      - name: Verify changes
        run: |
          echo "=== Changes to Formula/tui-delta.rb ==="
          git diff Formula/tui-delta.rb

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: Update tui-delta to v${{ github.event.client_payload.version }}"
          title: "Update tui-delta to v${{ github.event.client_payload.version }}"
          body: |
            Automatically generated PR to update tui-delta formula.

            **Version:** ${{ github.event.client_payload.version }}
            **PyPI Release:** https://pypi.org/project/tui_delta/${{ github.event.client_payload.version }}/

            ### Changes
            - Updated source URL and SHA256 hash
            - Updated version test assertion

            ### Testing Checklist
            - [ ] Verify SHA256 hash matches PyPI
            - [ ] Test local installation: `brew install --build-from-source JeffreyUrban/tui-delta/tui-delta`
            - [ ] Run tests: `brew test tui-delta`
            - [ ] Verify version: `tui-delta --version`

            ---
            *This PR was automatically created by the update-formula workflow triggered from the main tui-delta repository.*
          branch: update-v${{ github.event.client_payload.version }}
          delete-branch: true
          labels: |
            automated
            version-update

      - name: Verify PR was created
        run: |
          if [ -z "${{ steps.create-pr.outputs.pull-request-number }}" ]; then
            echo "❌ Error: No pull request was created!"
            echo "This likely means no changes were detected in the formula."
            echo "Check the 'Update formula' step output to verify the sed/awk commands matched correctly."
            exit 1
          fi
          echo "✅ Pull request #${{ steps.create-pr.outputs.pull-request-number }} created successfully"
          echo "PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"
